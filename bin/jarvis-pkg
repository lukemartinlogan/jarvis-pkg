#!/usr/bin/env python3

"""
USAGE:

jpkg install pkg_name@version variant=a variant=b +variant -variant ^ dep_name variant@version = a ^ dep_name ...
"""

from jarvis_pkg.basic.jpkg_manager import JpkgManager
from jarvis_pkg.basic.manifest_manager import ManifestManager
from jarvis_pkg.basic.package_manager import PackageManager
from jarvis_pkg.basic.package_installer import PackageInstaller
from jarvis_pkg.basic.query_parser import QueryParser

import argparse
from enum import Enum
import sys

class JarvisPkgOp(Enum):
    REGISTER = "register"
    INSTALL = "install"
    UNINSTALL = "uninstall"
    UPDATE = "update"
    LOAD = "load"
    LIST = "list"
    INFO = "info"
    VERSIONS = "versions"
    FIND = "find"
    REPO = "repo"


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='jpkg')
    parser.add_argument('op', metavar='operation',
                        type=JarvisPkgOp,
                        choices=list(JarvisPkgOp),
                        help="The jarvis-pkg operation")
    parser.add_argument('remainder', nargs=argparse.REMAINDER)
    args = parser.parse_args()

    if args.op == JarvisPkgOp.INSTALL:
        parser = QueryParser(args.remainder).parse()
        pkg_list = parser.pkgs
        installer = PackageInstaller.get_instance()
        installer.install(pkg_list)
        installer.save()
    elif args.op == JarvisPkgOp.UPDATE:
        parser = QueryParser(args.remainder).parse()
        pkg_list = parser.pkgs
        installer = PackageInstaller.get_instance()
        installer.update(pkg_list)
    elif args.op == JarvisPkgOp.UNINSTALL:
        parser = QueryParser(args.remainder).parse()
        pkg_list = parser.pkgs
        installer = PackageInstaller.get_instance()
        installer.uninstall(pkg_list)
        installer.save()
    elif args.op == JarvisPkgOp.LOAD:
        pass
    elif args.op == JarvisPkgOp.LIST:
        parser = QueryParser(args.remainder).parse()
        pkg_list = parser.pkgs
        manifest = ManifestManager.get_instance()
        manifest.parse_args(args.remainder)
    elif args.op == JarvisPkgOp.INFO:
        pass
    elif args.op == JarvisPkgOp.VERSIONS:
        pass
    elif args.op == JarvisPkgOp.FIND:
        parser = QueryParser(args.remainder).parse()
        pkg_list = parser.pkgs
        pkg_manager = PackageManager.get_instance()
        pkg_manager.list(pkg_list)
    elif args.op == JarvisPkgOp.REPO:
        manifest = ManifestManager.get_instance()
        manifest.parse_args(args.remainder)
        manifest.save()
